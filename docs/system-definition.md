# Reference: 業務遂行システム全体像 & 設計指針

## 1. システム目的と思想
本システムは、Roocode を用いて「判断責任を明確に保ったまま、高度な自律遂行を実現する」ためのスキャフォールドである。

### 基本原則
- **pmMode への集権**: ユーザー（人間）との唯一の窓口であり、全タスクの判断責任者である。
- **作業系 Mode の作業員化**: 他の Mode は pmMode からの指示を忠実に実行する「専門作業員」であり、判断主体ではない。
- **知識の参照主義**: 知識をプロンプトに内包せず、Layer 3（成果物・資料）を必要に応じて参照する。
- **要約の第一級成果物化**: LLM のコンテキスト制限を前提とし、状態の要約を常に最新に保つ。

---

## 2. 論理構造・アーキテクチャ
```text
User ⇅ pmMode (唯一の対話窓口・最終責任者)
      ├─ Skill (思考・設計・分析: Architect / Researcher / Planner)
      ├─ Orchestrator (内部制御: 各作業系 Mode への指示)
      │   ├─ Code Mode (実装)
      │   ├─ Writer Mode (文書化)
      │   ├─ Reviewer Mode (監査)
      │   ├─ QA Mode (品質保証)
      │   └─ Publisher Mode (デプロイ)
      └─ 成果物・参照資料 (GitHub / Docs / Context Layer 3)
```

---

## 3. モード定義と役割

### 3.1 pmMode (指揮官)
- **役割**: 要件理解、タスク分解、Skill/Mode の選択、判断・優先順位付け、最終報告。
- **原則**: 判断責任を手放さない。不確実性があれば必ずユーザーに戻す（エスカレーション）。

### 3.2 作業系 Mode (作業員・判断しない)
| Mode | 責務 | 完了定義 |
| :--- | :--- | :--- |
| **Code** | 実装・コード生成 | 指定された要件を満たすコードの提出 |
| **Writer** | 文書化・説明文生成 | 構造化された Markdown 成果物の提出 |
| **Reviewer** | 構造・論理レビュー | 契約に基づいた Pass/Fail と根拠の報告 |
| **QA** | 品質確認・テスト | metrics.yaml に基づくテスト証跡の提出 |
| **Publisher** | 公開・配置・通知 | デプロイ完了と Changelog の作成 |

---

## 4. Skill 設計（判断を持たない手順）
以下の役割は独立した Mode とせず、pmMode が思考プロセスとして実行する **Skill** として定義する。
- **Architect**: 技術的な構造設計・インターフェース定義
- **Researcher**: 技術調査・比較表作成
- **Planner**: 実行計画立案・WBS作成

---

## 5. コンテキスト管理（3層構造）
- **Layer 1: 固定コンテキスト** (pmMode 常駐ルール、判断原則)
- **Layer 2: プロジェクト状態** (決定事項の要約、現在の TODO、未解決課題)
- **Layer 3: 成果物全文** (コード、設計書、仕様書の実体)

---

## 6. 運用ルール・契約遵守
本リポジトリの `.roo/` 配下の定義は、システムの「静的契約（Static Contracts）」である。各 Mode および Skill は以下を遵守せよ。

1. **Mode は契約を遵守する**: 各 Mode は自身の `.md` に定義された `Input/Output Contract` を厳守し、`Forbidden Actions` を行わない。
2. **Skill は手順に徹する**: Skill は判断を持たない。判断が必要な入力が与えられた場合、Skill は停止し Mode に判断を委ねる。
3. **品質は定量評価する**: `policies/metrics.yaml` の閾値を満たさない成果物は、`quality.yaml` の定義に従い自動的に Rejection（差し戻し）の対象となる。

## 7. 拡張ガイドライン
新しい Mode や Skill を追加する場合、必ず本リポジトリのテンプレートに従い、以下の入出力契約を明確に定義すること。
- **Mode**: 役割、責任、禁忌事項、入出力フォーマット
- **Skill**: 純粋な手順、入力パラメータ、期待される成果物

---

## 8. 今後の検討事項（スナップショット）
本システムの完成に向けて、以下の詳細を順次確定させる。

### 8.1 ガバナンス・判断基準
- pmMode の具体的裁量範囲と、ユーザー介入が必須な判断の定義。
- 自律ループの許可条件と回数制限。

### 8.2 契約の詳細化
- `quality.yaml` および `metrics.yaml` の各工程における具体的な閾値。
- Mode 間の「差し戻し（Rejection）」の厳格なトリガー。

### 8.3 運用系 Skill の作成
- `project_state`（Layer 2）を自動更新・要約するための Skill 定義。
- Publisher における公開可否判断のチェックリスト。

### 8.4 フェイルセーフ
- 推論がループした場合、またはコンテキストが溢れた際の強制リセット手順。

---

## 9. モード統治フィロソフィー（階層化制約管理）
本システムでは、Mode の指示（Instructions）が肥大化し、基本原則が埋もれることを防ぐため、以下の三層構造による「階層化制約管理」を徹底する。

### 9.1 制約の三層構造
各 Mode のディレクトリ (`.roo/rules-{slug}/`) 内は、以下の優先順位と役割に基づいてファイルを配置しなければならない。

1. **`00-contract.md`（基本原則 / 憲法）**
   - **内容**: 役割、責任、入出力契約、禁忌事項。
   - **性質**: 不変。その Mode であるための最小かつ絶対の定義。
2. **`10-operational-guidelines.md`（運用指針 / 法律）**
   - **内容**: 具体的なケースにおける振る舞い、推奨される思考プロセス、他 Mode との連携作法。
   - **性質**: 動的。システム運用の知見に基づき、具体的かつ詳細な制御を行うための記述。
3. **`20-cases.md`（判例集 / 事例）**
   - **内容**: 過去の成功事例、失敗事例、特定のバグに対する再発防止策。
   - **性質**: 蓄積型。実際のデバッグ結果から得られた「具体的な期待動作」を記録。

### 9.2 適用ルール
- **原則の優先**: 具体的な指針が基本原則と矛盾する場合、常に `00-contract.md` が優先される。
- **肥大化の防止**: `00-contract.md` に具体的なケースを追記してはならない。具体性が高い指示は必ず `10-` 以降のファイルに分離すること。
- **テンプレートの遵守**: すべての定義ファイルおよびログは、`.roo/docs/templates/` 配下のテンプレート構造に従わなければならない。platform-maintainer はこの整合性を監査の最優先項目とする。
- **徹底**: pmMode だけでなく、すべての作業系 Mode においてもこの構造を維持し、Roo Code の指示コンテキストの純度を保つ。
