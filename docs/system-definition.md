# Reference: 業務遂行システム全体像 & 設計指針

## 1. システム目的と思想
本システムは、Roocode を用いて「判断責任を明確に保ったまま、高度な自律遂行を実現する」ためのスキャフォールドである。

### 基本原則
- **pmMode への集権**: ユーザー（人間）との唯一の窓口であり、全タスクの判断責任者である。
- **作業系 Mode の作業員化**: 他の Mode は pmMode からの指示を忠実に実行する「専門作業員」であり、判断主体ではない。
- **知識の参照主義**: 知識をプロンプトに内包せず、Layer 3（成果物・資料）を必要に応じて参照する。
- **要約の第一級成果物化**: LLM のコンテキスト制限を前提とし、状態の要約を常に最新に保つ。

---

## 2. 論理構造・アーキテクチャ
```text
User ⇅ pmMode (唯一の対話窓口・最終判断責任者)
      └─ Orchestrator (内部制御・厳格執行・事実判定)
          ├─ Code Mode (実装)
          ├─ Writer Mode (文書化)
          ├─ Reviewer Mode (監査)
          ├─ QA Mode (品質保証)
          └─ Publisher Mode (デプロイ)

※ Skill (Architect / Researcher / Planner) は pmMode の内部思考プロセスとして実行。
```

---

## 3. モード定義と役割

### 3.1 pmMode (指揮官)
- **役割**: ユーザー意図の理解、プラン（ワークフロー）の策定、最終判断。
- **通信**: 直接の通信相手は User と Orchestrator のみ。末端 Mode への直接指示は禁止。

### 3.2 Orchestrator (執行官)
- **役割**: pmMode から提供されたプランの厳格な執行。各 Mode へのタスクディスパッチ。
- **判断**: 独自の解釈（プラン変更）は禁止。各 Mode の成果物が「指示された完了定義」を満たしているかのみを事実に基づいて判定する。
- **エスカレーション**: 成果物が基準未達の場合、または Mode からエラーが返った場合、主観を交えず「事実」のみを pmMode に報告する。

### 3.3 作業系 Mode (作業員・判断しない)
- **通信**: 指示の受け取り、成果物の報告、エスカレーションの全てを Orchestrator とのみ行う。
- **判断**: 自身の専門領域外の判断が必要な場合は、即座に Orchestrator にエスカレーションする。

---

## 4. 通信プロトコル（階層構造）
本システムでは、情報のバイパス（階層を飛ばした通信）を厳禁とする。

1. **Top-Down (指示)**: User -> pmMode -> Orchestrator -> Worker Mode
2. **Bottom-Up (報告)**: Worker Mode -> Orchestrator -> pmMode -> User

### 4.1 エスカレーションルール
- Worker Mode は Orchestrator にのみ問題を報告する。
- Orchestrator は問題を整理し、pmMode に判断を仰ぐ。
- pmMode のみが、必要に応じて User にエスカレーションを行う。

---

## 4. Skill 設計（判断を持たない手順）
以下の役割は独立した Mode とせず、pmMode が思考プロセスとして実行する **Skill** として定義する。
- **Architect**: 技術的な構造設計・インターフェース定義
- **Researcher**: 技術調査・比較表作成
- **Planner**: 実行計画立案・WBS作成

---

## 5. コンテキスト管理（3層構造）
- **Layer 1: 固定コンテキスト** (pmMode 常駐ルール、判断原則)
- **Layer 2: プロジェクト状態** (決定事項の要約、現在の TODO、未解決課題)
- **Layer 3: 成果物全文** (コード、設計書、仕様書の実体)

---

## 6. 運用ルール・契約遵守
本リポジトリの `.roo/` 配下の定義は、システムの「静的契約（Static Contracts）」である。各 Mode および Skill は以下を遵守せよ。

1. **Mode は契約を遵守する**: 各 Mode は自身の `.md` に定義された `Input/Output Contract` を厳守し、`Forbidden Actions` を行わない。
2. **Skill は手順に徹する**: Skill は判断を持たない。判断が必要な入力が与えられた場合、Skill は停止し Mode に判断を委ねる。
3. **品質は定量評価する**: `policies/metrics.yaml` の閾値を満たさない成果物は、`quality.yaml` の定義に従い自動的に Rejection（差し戻し）の対象となる。

## 7. 拡張ガイドライン
新しい Mode や Skill を追加する場合、必ず本リポジトリのテンプレートに従い、以下の入出力契約を明確に定義すること。
- **Mode**: 役割、責任、禁忌事項、入出力フォーマット
- **Skill**: 純粋な手順、入力パラメータ、期待される成果物

---

## 8. 今後の検討事項（スナップショット）
本システムの完成に向けて、以下の詳細を順次確定させる。

### 8.1 ガバナンス・判断基準
- pmMode の具体的裁量範囲と、ユーザー介入が必須な判断の定義。
- 自律ループの許可条件と回数制限。

### 8.2 契約の詳細化
- `quality.yaml` および `metrics.yaml` の各工程における具体的な閾値。
- Mode 間の「差し戻し（Rejection）」の厳格なトリガー。

### 8.3 運用系 Skill の作成
- `project_state`（Layer 2）を自動更新・要約するための Skill 定義。
- Publisher における公開可否判断のチェックリスト。

### 8.4 フェイルセーフ
- 推論がループした場合、またはコンテキストが溢れた際の強制リセット手順。

---

## 9. モード統治フィロソフィー（階層化制約管理）
本システムでは、Mode の指示（Instructions）が肥大化し、基本原則が埋もれることを防ぐため、以下の三層構造による「階層化制約管理」を徹底する。

### 9.1 制約の三層構造
各 Mode のディレクトリ (`.roo/rules-{slug}/`) 内は、以下の優先順位と役割に基づいてファイルを配置しなければならない。

1. **`00-contract.md`（基本原則 / 憲法）**
   - **内容**: 役割、責任、入出力契約、禁忌事項。
   - **性質**: 不変。その Mode であるための最小かつ絶対の定義。
2. **`10-operational-guidelines.md`（運用指針 / 法律）**
   - **内容**: 具体的なケースにおける振る舞い、推奨される思考プロセス、他 Mode との連携作法。
   - **性質**: 動的。システム運用の知見に基づき、具体的かつ詳細な制御を行うための記述。
3. **`20-cases.md`（判例集 / 事例）**
   - **内容**: 過去の成功事例、失敗事例、特定のバグに対する再発防止策。
   - **性質**: 蓄積型。実際のデバッグ結果から得られた「具体的な期待動作」を記録。

### 9.2 適用ルール
- **原則の優先**: 具体的な指針が基本原則と矛盾する場合、常に `00-contract.md` が優先される。
- **肥大化の防止**: `00-contract.md` に具体的なケースを追記してはならない。具体性が高い指示は必ず `10-` 以降のファイルに分離すること。
- **テンプレートの遵守**: すべての定義ファイルおよびログは、`.roo/docs/templates/` 配下のテンプレート構造に従わなければならない。platform-maintainer はこの整合性を監査の最優先項目とする。
- **徹底**: pmMode だけでなく、すべての作業系 Mode においてもこの構造を維持し、Roo Code の指示コンテキストの純度を保つ。
